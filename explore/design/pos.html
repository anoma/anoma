<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Proof of Stake system - Anoma - Technical Specifications</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../assets/custom.css">
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../../explore/index.html"><strong aria-hidden="true">2.</strong> Exploration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../explore/design/index.html"><strong aria-hidden="true">2.1.</strong> Design</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../explore/design/overview.html"><strong aria-hidden="true">2.1.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../explore/design/gossip.html"><strong aria-hidden="true">2.1.2.</strong> Gossip network</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../explore/design/intent_gossip/intent_gossip.html"><strong aria-hidden="true">2.1.2.1.</strong> Intent gossip</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../explore/design/intent_gossip/intent.html"><strong aria-hidden="true">2.1.2.1.1.</strong> intent</a></li><li class="chapter-item expanded "><a href="../../explore/design/intent_gossip/topic.html"><strong aria-hidden="true">2.1.2.1.2.</strong> topic</a></li><li class="chapter-item expanded "><a href="../../explore/design/intent_gossip/incentive.html"><strong aria-hidden="true">2.1.2.1.3.</strong> incentive</a></li><li class="chapter-item expanded "><a href="../../explore/design/intent_gossip/matchmaker.html"><strong aria-hidden="true">2.1.2.1.4.</strong> matchmaker</a></li><li class="chapter-item expanded "><a href="../../explore/design/intent_gossip/fungible_token.html"><strong aria-hidden="true">2.1.2.1.5.</strong> fungible token</a></li></ol></li><li class="chapter-item expanded "><a href="../../explore/design/dkg.html"><strong aria-hidden="true">2.1.2.2.</strong> Distributed key generation gossip</a></li></ol></li><li class="chapter-item expanded "><a href="../../explore/design/ledger.html"><strong aria-hidden="true">2.1.3.</strong> The ledger</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../explore/design/ledger/parameters.html"><strong aria-hidden="true">2.1.3.1.</strong> Parameters</a></li><li class="chapter-item expanded "><a href="../../explore/design/ledger/epochs.html"><strong aria-hidden="true">2.1.3.2.</strong> Epochs</a></li><li class="chapter-item expanded "><a href="../../explore/design/ledger/accounts.html"><strong aria-hidden="true">2.1.3.3.</strong> Accounts</a></li><li class="chapter-item expanded "><a href="../../explore/design/ledger/vp.html"><strong aria-hidden="true">2.1.3.4.</strong> Validity predicates</a></li><li class="chapter-item expanded "><a href="../../explore/design/ledger/tx.html"><strong aria-hidden="true">2.1.3.5.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="../../explore/design/ledger/wasm-vm.html"><strong aria-hidden="true">2.1.3.6.</strong> WASM VM</a></li><li class="chapter-item expanded "><a href="../../explore/design/ledger/front-running.html"><strong aria-hidden="true">2.1.3.7.</strong> Front-running prevention</a></li><li class="chapter-item expanded "><a href="../../explore/design/fractal-scaling.html"><strong aria-hidden="true">2.1.3.8.</strong> Fractal scaling</a></li><li class="chapter-item expanded "><a href="../../explore/design/upgrade-system.html"><strong aria-hidden="true">2.1.3.9.</strong> Upgrade system</a></li><li class="chapter-item expanded "><a href="../../explore/design/storage.html"><strong aria-hidden="true">2.1.3.10.</strong> Storage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../explore/design/data-schema.html"><strong aria-hidden="true">2.1.3.10.1.</strong> Data schema</a></li></ol></li><li class="chapter-item expanded "><a href="../../explore/design/ledger/pos-integration.html"><strong aria-hidden="true">2.1.3.11.</strong> PoS integration</a></li></ol></li><li class="chapter-item expanded "><a href="../../explore/design/crypto-primitives.html"><strong aria-hidden="true">2.1.4.</strong> Crypto primitives</a></li><li class="chapter-item expanded "><a href="../../explore/design/actors.html"><strong aria-hidden="true">2.1.5.</strong> Actors</a></li><li class="chapter-item expanded "><a href="../../explore/design/pos.html" class="active"><strong aria-hidden="true">2.1.6.</strong> Proof of Stake system</a></li></ol></li><li class="chapter-item expanded "><a href="../../explore/prototypes/index.html"><strong aria-hidden="true">2.2.</strong> Prototypes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../explore/prototypes/base-ledger.html"><strong aria-hidden="true">2.2.1.</strong> Base ledger</a></li><li class="chapter-item expanded "><a href="../../explore/prototypes/gossip-layer.html"><strong aria-hidden="true">2.2.2.</strong> Gossip layer</a></li></ol></li><li class="chapter-item expanded "><a href="../../explore/libraries/index.html"><strong aria-hidden="true">2.3.</strong> Libraries &amp; Tools</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">2.3.1.</strong> Cryptography</div></li><li class="chapter-item expanded "><a href="../../explore/libraries/network.html"><strong aria-hidden="true">2.3.2.</strong> network</a></li><li class="chapter-item expanded "><a href="../../explore/libraries/cli.html"><strong aria-hidden="true">2.3.3.</strong> Command-line interface</a></li><li class="chapter-item expanded "><a href="../../explore/libraries/db.html"><strong aria-hidden="true">2.3.4.</strong> Database</a></li><li class="chapter-item expanded "><a href="../../explore/libraries/logging.html"><strong aria-hidden="true">2.3.5.</strong> Logging</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.3.6.</strong> Networking</div></li><li class="chapter-item expanded "><a href="../../explore/libraries/packaging.html"><strong aria-hidden="true">2.3.7.</strong> Packaging</a></li><li class="chapter-item expanded "><a href="../../explore/libraries/serialization.html"><strong aria-hidden="true">2.3.8.</strong> Serialization</a></li><li class="chapter-item expanded "><a href="../../explore/libraries/wasm.html"><strong aria-hidden="true">2.3.9.</strong> WASM runtime</a></li><li class="chapter-item expanded "><a href="../../explore/libraries/errors.html"><strong aria-hidden="true">2.3.10.</strong> Error handling</a></li></ol></li><li class="chapter-item expanded "><a href="../../explore/design/glossary.html"><strong aria-hidden="true">2.4.</strong> Glossary</a></li><li class="chapter-item expanded "><a href="../../explore/resources/index.html"><strong aria-hidden="true">2.5.</strong> Resources</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../explore/resources/ide.html"><strong aria-hidden="true">2.5.1.</strong> IDE</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../specs/index.html"><strong aria-hidden="true">3.</strong> Specifications</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../specs/overview.html"><strong aria-hidden="true">3.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../specs/ledger.html"><strong aria-hidden="true">3.2.</strong> The ledger</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.3.</strong> Trade system</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.4.</strong> Intent gossip system</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.5.</strong> Fractal scaling</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.6.</strong> Upgrade system</div></li><li class="chapter-item expanded "><a href="../../specs/encoding.html"><strong aria-hidden="true">3.7.</strong> Encoding</a></li></ol></li><li class="chapter-item expanded "><a href="../../playnet/index.html"><strong aria-hidden="true">4.</strong> Playnet</a></li><li class="chapter-item expanded "><a href="../../archive/index.html"><strong aria-hidden="true">5.</strong> Archive</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../archive/domain-name-addresses.html"><strong aria-hidden="true">5.1.</strong> Domain name addresses</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Anoma - Technical Specifications</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="proof-of-stake-pos-system"><a class="header" href="#proof-of-stake-pos-system">Proof of Stake (PoS) system</a></h1>
<h2 id="epoch"><a class="header" href="#epoch">Epoch</a></h2>
<p>An epoch is a range of blocks or time that is defined by the base ledger and made available to the PoS system. This document assumes that epochs are identified by consecutive natural numbers. All the data relevant to PoS are <a href="#epoched-data">associated with epochs</a>.</p>
<h3 id="epoched-data"><a class="header" href="#epoched-data">Epoched data</a></h3>
<p>Epoched data are data associated with a specific epoch that are set in advance. The data relevant to the PoS system in the ledger's state are epoched. Each data can be uniquely identified. These are:</p>
<ul>
<li><a href="#system-parameters">System parameters</a>. A single value for each epoch.</li>
<li><a href="#active-validator-set">Active validator set</a>. A single value for each epoch.</li>
<li>Total voting power. A sum of all active and inactive validators' voting power. A single value for each epoch.</li>
<li><a href="#validator">Validators' consensus key, state and total bonded tokens</a>. Identified by the validator's address.</li>
<li><a href="#bonds">Bonds</a> are created by self-bonding and delegations. They are identified by the pair of source address and the validator's address.</li>
</ul>
<p>Changes to the epoched data do not take effect immediately. Instead, changes in epoch <code>n</code> are queued to take effect in the epoch <code>n + pipeline_length</code> for most cases and <code>n + unboding_length</code> for <a href="#unbond">unbonding</a> actions. Should the same validator's data or same bonds (i.e. with the same identity) be updated more than once in the same epoch, the later update overrides the previously queued-up update. For bonds, the token amounts are added up. Once the epoch <code>n</code> has ended, the queued-up updates for epoch <code>n + pipeline_length</code> are final and the values become immutable.</p>
<h2 id="entities"><a class="header" href="#entities">Entities</a></h2>
<ul>
<li><a href="#validator">Validator</a>: An account with a public consensus key, which may participate in producing blocks and governance activities. A validator may not also be a delegator.</li>
<li><a href="#delegator">Delegator</a>: An account that delegates some tokens to a validator. A delegator may not also be a validator.</li>
</ul>
<p>Additionally, any account may submit evidence for <a href="#slashing">a slashable misbehaviour</a>.</p>
<h3 id="validator"><a class="header" href="#validator">Validator</a></h3>
<p>A validator must have a public consensus key. Additionally, it may also specify optional metadata fields (TBA).</p>
<p>A validator may be in one of the following states:</p>
<ul>
<li><em>inactive</em>:
A validator is not being considered for block creation and cannot receive any new delegations.</li>
<li><em>pending</em>:
A validator has requested to become a <em>candidate</em>.</li>
<li><em>candidate</em>:
A validator is considered for block creation and can receive delegations.</li>
</ul>
<p>For each validator (in any state), the system also tracks total bonded tokens as a sum of the tokens in their self-bonds and delegated bonds, less any unbonded tokens. The total bonded tokens determine their voting voting power by multiplication by the <code>votes_per_token</code> <a href="#system-parameters">parameter</a>. The voting power is used for validator selection for block creation and is used in governance related activities.</p>
<h4 id="validator-actions"><a class="header" href="#validator-actions">Validator actions</a></h4>
<ul>
<li><em>become validator</em>:
Any account that is not a validator already and that doesn't have any delegations may request to become a validator. It is required to provide a public consensus key and staking reward address. For the action applied in epoch <code>n</code>, the validator's state will be immediately set to <em>pending</em>, it will be set to <em>candidate</em> for epoch <code>n + pipeline_length</code> and the consensus key is set for epoch <code>n + pipeline_length</code>.</li>
<li><em>deactivate</em>:
Only a <em>pending</em> or <em>candidate</em> validator account may <em>deactivate</em>. For this action applied in epoch <code>n</code>, the validator's account is set to become <em>inactive</em> in the epoch <code>n + pipeline_length</code>.</li>
<li><em>reactivate</em>:
Only an <em>inactive</em> validator may <em>reactivate</em>. Similarly to <em>become validator</em> action, for this action applied in epoch <code>n</code>, the validator's state will be immediately set to <em>pending</em> and it will be set to <em>candidate</em> for epoch <code>n + pipeline_length</code>.</li>
<li><em>self-bond</em>:
A validator may lock-up tokens into a <a href="#bonds">bond</a> only for its own validator's address.</li>
<li><em>unbond</em>:
Any self-bonded tokens may be partially or fully <a href="#unbond">unbonded</a>.</li>
<li><em>withdraw unbonds</em>:
Unbonded tokens may be withdrawn in or after the <a href="#unbond">unbond's epoch</a>.</li>
<li><em>change consensus key</em>:
Set the new consensus key. When applied in epoch <code>n</code>, the key is set for epoch <code>n + pipeline_length</code>.</li>
</ul>
<h4 id="active-validator-set"><a class="header" href="#active-validator-set">Active validator set</a></h4>
<p>From all the <em>candidate</em> validators, in each epoch the ones with the most voting power limited up to the <code>max_active_validators</code> <a href="#system-parameters">parameter</a> are selected for the active validator set. The active validator set selected in epoch <code>n</code> is set for epoch <code>n + pipeline_length</code>.</p>
<h3 id="delegator"><a class="header" href="#delegator">Delegator</a></h3>
<p>A delegator may have any number of delegations to any number of validators. Delegations are stored in <a href="#bonds">bonds</a>.</p>
<h4 id="delegator-actions"><a class="header" href="#delegator-actions">Delegator actions</a></h4>
<ul>
<li><em>delegate</em>:
An account which is not a validator may delegate tokens to any number of validators. This will lock-up tokens into a <a href="#bonds">bond</a>.</li>
<li><em>undelegate</em>:
Any delegated tokens may be partially or fully <a href="#unbond">unbonded</a>.</li>
<li><em>withdraw unbonds</em>:
Unbonded tokens may be withdrawn in or after the <a href="#unbond">unbond's epoch</a>.</li>
</ul>
<h2 id="bonds"><a class="header" href="#bonds">Bonds</a></h2>
<p>A bond locks-up tokens from validators' self-bonding and delegators' delegations. For self-bonding, the source address is equal to the validator's address. Only validators can self-bond. For a bond created from a delegation, the bond's source is the delegator's account.</p>
<p>For each epoch, bonds are uniquely identified by the pair of source and validator's addresses. A bond created in epoch <code>n</code> is written into epoch <code>n + pipeline_length</code>. If there already is a bond in the epoch <code>n + pipeline_length</code> for this pair of source and validator's addresses, its tokens are incremented by the newly bonded amount.</p>
<p>Any bonds created in epoch <code>n</code> increment the bond's validator's total bonded tokens by the bond's token amount and update the voting power for epoch <code>n + pipeline_length</code>.</p>
<p>The tokens put into a bond are immediately deducted from the source account.</p>
<h3 id="unbond"><a class="header" href="#unbond">Unbond</a></h3>
<p>An unbonding action (validator <em>unbond</em> or delegator <em>undelegate</em>) requested by the bond's source account in epoch <code>n</code> creates an &quot;unbond&quot; with epoch set to <code>n + unbounding_length</code>. We also store the epoch of the bond(s) from which the unbond is created in order to determine if the unbond should be slashed if a fault occurred within the range of bond epoch (inclusive) and unbond epoch (exclusive).</p>
<p>Any unbonds created in epoch <code>n</code> decrements the bond's validator's total bonded tokens by the bond's token amount and update the voting power for epoch <code>n + unbonding_length</code>.</p>
<p>An &quot;unbond&quot; with epoch set to <code>n</code> may be withdrawn by the bond's source address in or any time after the epoch <code>n</code>. Once withdrawn, the unbond is deleted and the tokens are credited to the source account.</p>
<h3 id="staking-rewards"><a class="header" href="#staking-rewards">Staking rewards</a></h3>
<p>To a validator who proposed a block, the system rewards tokens based on the <code>block_proposer_reward</code> <a href="#system-parameters">system parameter</a> and each validator that voted on a block receives <code>block_vote_reward</code>.</p>
<h3 id="slashing"><a class="header" href="#slashing">Slashing</a></h3>
<p>Instead of absolute values, validators' total bonded token amounts and bonds' and unbonds' token amounts are stored as their deltas (i.e. the change of quantity from a previous epoch) to allow distinguishing changes for different epoch, which is essential for determining whether tokens should be slashed. However, because slashes for a fault that occurred in epoch <code>n</code> may only be applied before the beginning of epoch <code>n + unbonding_length</code>, in epoch <code>m</code> we can sum all the deltas of total bonded token amounts and bonds and unbond with the same source and validator for epoch equal or less than <code>m - unboding_length</code> into a single total bonded token amount, single bond and single unbond record. This is to keep the total number of total bonded token amounts for a unique validator and bonds and unbonds for a unique pair of source and validator bound to a maximum number (equal to <code>unbonding_length</code>).</p>
<p>To disincentivize validators misbehaviour in the PoS system a validator may be slashed for any fault that it has done. An evidence of misbehaviour may be submitted by any account for a fault that occurred in epoch <code>n</code> anytime before the beginning of epoch <code>n + unbonding_length</code>.</p>
<p>A valid evidence reduces the validator's total bonded token amount by the slash rate in and before the epoch in which the fault occurred. The validator's voting power must also be adjusted to the slashed total bonded token amount. Additionally, a slash is stored with the misbehaving validator's address and the relevant epoch in which the fault occurred. When an unbond is being withdrawn, we first look-up if any slash occurred within the range of epochs in which these were active and if so, reduce its token amount by the slash rate. Note that bonds and unbonds amounts are not slashed until their tokens are withdrawn.</p>
<p>The invariant is that the sum of amounts that may be withdrawn from a misbehaving validator must always add up to the total bonded token amount.</p>
<h2 id="system-parameters"><a class="header" href="#system-parameters">System parameters</a></h2>
<p>The default values that are relative to epoch duration assume that an epoch last about 24 hours.</p>
<ul>
<li><code>max_validator_slots</code>: Maximum active validators, default <code>128</code></li>
<li><code>pipeline_len</code>: Pipeline length in number of epochs, default <code>2</code></li>
<li><code>unboding_len</code>: Unbonding duration in number of epochs, default <code>6</code></li>
<li><code>votes_per_token</code>: Used in validators' voting power calculation, default 100‱ (1 voting power unit per 1000 tokens)</li>
<li><code>block_proposer_reward</code>: Amount of tokens rewarded to a validator for proposing a block</li>
<li><code>block_vote_reward</code>: Amount of tokens rewarded to each validator that voted on a block proposal</li>
<li><code>duplicate_vote_slash_rate</code>: Portion of validator's stake that should be slashed on a duplicate vote</li>
<li><code>light_client_attack_slash_rate</code>: Portion of validator's stake that should be slashed on a light client attack</li>
</ul>
<h2 id="storage"><a class="header" href="#storage">Storage</a></h2>
<p>The <a href="#system-parameters">system parameters</a> are written into the storage to allow for their changes. Additionally, each validator may record a new parameters value under their sub-key that they wish to change to, which would override the systems parameters when more than 2/3 voting power are in agreement on all the parameters values.</p>
<p>The validators' data are keyed by the their addresses, conceptually:</p>
<pre><code class="language-rust ignore">type Validators = HashMap&lt;Address, Validator&gt;;
</code></pre>
<p>Epoched data are stored in the following structure:</p>
<pre><code class="language-rust ignore">struct Epoched&lt;Data&gt; {
  /// The epoch in which this data was last updated
  last_update: Epoch,
  /// Dynamically sized vector in which the head is the data for epoch in which 
  /// the `last_update` was performed and every consecutive array element is the
  /// successor epoch of the predecessor array element. For system parameters, 
  /// validator's consensus key and state, `LENGTH = pipeline_length + 1`. 
  /// For all others, `LENGTH = unbonding_length + 1`.
  data: Vec&lt;Option&lt;Data&gt;&gt;
}
</code></pre>
<p>Note that not all epochs will have data set, only the ones in which some changes occurred.</p>
<p>To try to look-up a value for <code>Epoched</code> data with independent values in each epoch (such as the active validator set) in the current epoch <code>n</code>:</p>
<ol>
<li>let <code>index = min(n - last_update, pipeline_length)</code></li>
<li>read the <code>data</code> field at <code>index</code>:
<ol>
<li>if there's a value at <code>index</code> return it</li>
<li>else if <code>index == 0</code>, return <code>None</code></li>
<li>else decrement <code>index</code> and repeat this sub-step from 1.</li>
</ol>
</li>
</ol>
<p>To look-up a value for <code>Epoched</code> data with delta values in the current epoch <code>n</code>:</p>
<ol>
<li>let <code>end = min(n - last_update, pipeline_length) + 1</code></li>
<li>sum all the values that are not <code>None</code> in the <code>0 .. end</code> range bounded inclusively below and exclusively above</li>
</ol>
<p>To update a value in <code>Epoched</code> data with independent values in epoch <code>n</code> with value <code>new</code> for epoch <code>m</code>:</p>
<ol>
<li>let <code>shift = min(n - last_update, pipeline_length)</code></li>
<li>if <code>shift == 0</code>:
<ol>
<li><code>data[m - n] = new</code></li>
</ol>
</li>
<li>else:
<ol>
<li>for <code>i in 0 .. shift</code> range bounded inclusively below and exclusively above, set <code>data[i] = None</code></li>
<li>rotate <code>data</code> left by <code>shift</code></li>
<li>set <code>data[m - n] = new</code></li>
<li>set <code>last_update</code> to the current epoch</li>
</ol>
</li>
</ol>
<p>To update a value in <code>Epoched</code> data with delta values in epoch <code>n</code> with value <code>delta</code> for epoch <code>m</code>:</p>
<ol>
<li>let <code>shift = min(n - last_update, pipeline_length)</code></li>
<li>if <code>shift == 0</code>:
<ol>
<li>set <code>data[m - n] = data[m - n].map_or_else(delta, |last_delta| last_delta + delta)</code> (add the <code>delta</code> to the previous value, if any, otherwise use the <code>delta</code> as the value)</li>
</ol>
</li>
<li>else:
<ol>
<li>let <code>sum</code> to be equal to the sum of all delta values in the <code>i in 0 .. shift</code> range bounded inclusively below and exclusively above and set <code>data[i] = None</code></li>
<li>rotate <code>data</code> left by <code>shift</code></li>
<li>set <code>data[0] = data[0].map_or_else(sum, |last_delta| last_delta + sum)</code></li>
<li>set <code>data[m - n] = delta</code></li>
<li>set <code>last_update</code> to the current epoch</li>
</ol>
</li>
</ol>
<p>The invariants for updates in both cases are that <code>m - n &gt;= 0</code> and <code>m - n &lt;= pipeline_length</code>.</p>
<p>For the active validator set, we store all the active and inactive validators separately with their respective voting power:</p>
<pre><code class="language-rust ignore">type VotingPower = u64;

/// Validator's address with its voting power.
#[derive(PartialEq, Eq, PartialOrd, Ord)]
struct WeightedValidator {
  /// The `voting_power` field must be on top, because lexicographic ordering is
  /// based on the top-to-bottom declaration order and in the `ValidatorSet`
  /// the `WeighedValidator`s these need to be sorted by the `voting_power`.
  voting_power: VotingPower,
  address: Address,
}

struct ValidatorSet {
  /// Active validator set with maximum size equal to `max_active_validators`
  active: BTreeSet&lt;WeightedValidator&gt;,
  /// All the other validators that are not active
  inactive: BTreeSet&lt;WeightedValidator&gt;,
}

type ValidatorSets = Epoched&lt;ValidatorSet&gt;;

/// The sum of all active and inactive validators' voting power
type TotalVotingPower = Epoched&lt;VotingPower&gt;;
</code></pre>
<p>When any validator's voting power changes, we attempt to perform the following update on the <code>ActiveValidatorSet</code>:</p>
<ol>
<li>let <code>validator</code> be the validator's address, <code>power_before</code> and <code>power_after</code> be the voting power before and after the change, respectively</li>
<li>let <code>power_delta = power_after - power_before</code></li>
<li>let <code>min_active = active.first()</code> (active validator with lowest voting power)</li>
<li>let <code>max_inactive = inactive.last()</code> (inactive validator with greatest voting power)</li>
<li>find whether the validator is active, let <code>is_active = power_before &gt;= max_inactive.voting_power</code>
<ol>
<li>if <code>is_active</code>:
<ol>
<li>if <code>power_delta &gt; 0 &amp;&amp; power_after &gt; max_inactive.voting_power</code>, update the validator in <code>active</code> set with <code>voting_power = power_after</code></li>
<li>else, remove the validator from <code>active</code>, insert it into <code>inactive</code> and remove <code>max_inactive.address</code> from <code>inactive</code> and insert it into <code>active</code></li>
</ol>
</li>
<li>else (<code>!is_active</code>):
<ol>
<li>if <code>power_delta &lt; 0 &amp;&amp; power_after &lt; min_active.voting_power</code>, update the validator in <code>inactive</code> set with <code>voting_power = power_after</code></li>
<li>else, remove the validator from <code>inactive</code>, insert it into <code>active</code> and remove <code>min_active.address</code> from <code>active</code> and insert it into <code>inactive</code></li>
</ol>
</li>
</ol>
</li>
</ol>
<p>Within each validator's address space, we store public consensus key, state, total bonded token amount and voting power calculated from the total bonded token amount (even though the voting power is stored in the <code>ValidatorSet</code>, we also need to have the <code>voting_power</code> here because we cannot look it up in the <code>ValidatorSet</code> without iterating the whole set):</p>
<pre><code class="language-rust ignore">struct Validator {
  consensus_key: Epoched&lt;PublicKey&gt;,
  state: Epoched&lt;ValidatorState&gt;,
  total_deltas: Epoched&lt;token::Amount&gt;,
  voting_power: Epoched&lt;VotingPower&gt;,
}

enum ValidatorState {
  Inactive,
  Pending,
  Candidate,
}
</code></pre>
<p>The bonds and unbonds are keyed by their identifier:</p>
<pre><code class="language-rust ignore">type Bonds = HashMap&lt;BondId, Epoched&lt;Bond&gt;&gt;;
type Unbonds = HashMap&lt;BondId, Epoched&lt;Unbond&gt;&gt;;

struct BondId {
  validator: Address,
  /// The delegator adddress for delegations, or the same as the `validator`
  /// address for self-bonds.
  source: Address,
}

struct Bond {
  /// A key is a the epoch set for the bond. This is used in unbonding, where
  // it's needed for slash epoch range check.
  deltas: HashMap&lt;Epoch, token::Amount&gt;,
}

struct Unbond {
  /// A key is a pair of the epoch of the bond from which a unbond was created
  /// the epoch of unboding. This is needed for slash epoch range check.
  deltas: HashMap&lt;(Epoch, Epoch), token::Amount&gt;
}
</code></pre>
<p>For slashes, we store the epoch and block height at which the fault occurred, slash rate and the slash type:</p>
<pre><code class="language-rust ignore">struct Slash {
  epoch: Epoch,
  block_height: u64,
  /// slash token amount ‱ (per ten thousand)
  rate: u8,
  r#type: SlashType,
}
</code></pre>
<h2 id="initialization"><a class="header" href="#initialization">Initialization</a></h2>
<p>An initial validator set with self-bonded token amounts must be given on system initialization.</p>
<p>This set is used to pre-compute epochs in the genesis block from epoch <code>0</code> to epoch <code>pipeline_length - 1</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../explore/design/actors.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../explore/prototypes/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../explore/design/actors.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../explore/prototypes/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../../assets/mermaid.min.js"></script>
        <script type="text/javascript" src="../../assets/mermaid-init.js"></script>
    </body>
</html>
