<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Accounts - Anoma - Technical Specifications</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../assets/custom.css">
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../../../explore/index.html"><strong aria-hidden="true">2.</strong> Exploration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../explore/design/index.html"><strong aria-hidden="true">2.1.</strong> Design</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../explore/design/overview.html"><strong aria-hidden="true">2.1.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../../explore/design/gossip.html"><strong aria-hidden="true">2.1.2.</strong> Gossip network</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../explore/design/intent_gossip/intent_gossip.html"><strong aria-hidden="true">2.1.2.1.</strong> Intent gossip</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../explore/design/intent_gossip/intent.html"><strong aria-hidden="true">2.1.2.1.1.</strong> intent</a></li><li class="chapter-item expanded "><a href="../../../explore/design/intent_gossip/topic.html"><strong aria-hidden="true">2.1.2.1.2.</strong> topic</a></li><li class="chapter-item expanded "><a href="../../../explore/design/intent_gossip/incentive.html"><strong aria-hidden="true">2.1.2.1.3.</strong> incentive</a></li><li class="chapter-item expanded "><a href="../../../explore/design/intent_gossip/matchmaker.html"><strong aria-hidden="true">2.1.2.1.4.</strong> matchmaker</a></li><li class="chapter-item expanded "><a href="../../../explore/design/intent_gossip/fungible_token.html"><strong aria-hidden="true">2.1.2.1.5.</strong> fungible token</a></li></ol></li><li class="chapter-item expanded "><a href="../../../explore/design/dkg.html"><strong aria-hidden="true">2.1.2.2.</strong> Distributed key generation gossip</a></li></ol></li><li class="chapter-item expanded "><a href="../../../explore/design/ledger.html"><strong aria-hidden="true">2.1.3.</strong> The ledger</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../explore/design/ledger/parameters.html"><strong aria-hidden="true">2.1.3.1.</strong> Parameters</a></li><li class="chapter-item expanded "><a href="../../../explore/design/ledger/epochs.html"><strong aria-hidden="true">2.1.3.2.</strong> Epochs</a></li><li class="chapter-item expanded "><a href="../../../explore/design/ledger/accounts.html" class="active"><strong aria-hidden="true">2.1.3.3.</strong> Accounts</a></li><li class="chapter-item expanded "><a href="../../../explore/design/ledger/vp.html"><strong aria-hidden="true">2.1.3.4.</strong> Validity predicates</a></li><li class="chapter-item expanded "><a href="../../../explore/design/ledger/tx.html"><strong aria-hidden="true">2.1.3.5.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="../../../explore/design/ledger/wasm-vm.html"><strong aria-hidden="true">2.1.3.6.</strong> WASM VM</a></li><li class="chapter-item expanded "><a href="../../../explore/design/ledger/front-running.html"><strong aria-hidden="true">2.1.3.7.</strong> Front-running prevention</a></li><li class="chapter-item expanded "><a href="../../../explore/design/fractal-scaling.html"><strong aria-hidden="true">2.1.3.8.</strong> Fractal scaling</a></li><li class="chapter-item expanded "><a href="../../../explore/design/upgrade-system.html"><strong aria-hidden="true">2.1.3.9.</strong> Upgrade system</a></li><li class="chapter-item expanded "><a href="../../../explore/design/storage.html"><strong aria-hidden="true">2.1.3.10.</strong> Storage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../explore/design/data-schema.html"><strong aria-hidden="true">2.1.3.10.1.</strong> Data schema</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../explore/design/crypto-primitives.html"><strong aria-hidden="true">2.1.4.</strong> Crypto primitives</a></li><li class="chapter-item expanded "><a href="../../../explore/design/actors.html"><strong aria-hidden="true">2.1.5.</strong> Actors</a></li></ol></li><li class="chapter-item expanded "><a href="../../../explore/prototypes/index.html"><strong aria-hidden="true">2.2.</strong> Prototypes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../explore/prototypes/base-ledger.html"><strong aria-hidden="true">2.2.1.</strong> Base ledger</a></li><li class="chapter-item expanded "><a href="../../../explore/prototypes/gossip-layer.html"><strong aria-hidden="true">2.2.2.</strong> Gossip layer</a></li></ol></li><li class="chapter-item expanded "><a href="../../../explore/libraries/index.html"><strong aria-hidden="true">2.3.</strong> Libraries &amp; Tools</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">2.3.1.</strong> Cryptography</div></li><li class="chapter-item expanded "><a href="../../../explore/libraries/network.html"><strong aria-hidden="true">2.3.2.</strong> network</a></li><li class="chapter-item expanded "><a href="../../../explore/libraries/cli.html"><strong aria-hidden="true">2.3.3.</strong> Command-line interface</a></li><li class="chapter-item expanded "><a href="../../../explore/libraries/db.html"><strong aria-hidden="true">2.3.4.</strong> Database</a></li><li class="chapter-item expanded "><a href="../../../explore/libraries/logging.html"><strong aria-hidden="true">2.3.5.</strong> Logging</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.3.6.</strong> Networking</div></li><li class="chapter-item expanded "><a href="../../../explore/libraries/packaging.html"><strong aria-hidden="true">2.3.7.</strong> Packaging</a></li><li class="chapter-item expanded "><a href="../../../explore/libraries/serialization.html"><strong aria-hidden="true">2.3.8.</strong> Serialization</a></li><li class="chapter-item expanded "><a href="../../../explore/libraries/wasm.html"><strong aria-hidden="true">2.3.9.</strong> WASM runtime</a></li><li class="chapter-item expanded "><a href="../../../explore/libraries/errors.html"><strong aria-hidden="true">2.3.10.</strong> Error handling</a></li></ol></li><li class="chapter-item expanded "><a href="../../../explore/design/glossary.html"><strong aria-hidden="true">2.4.</strong> Glossary</a></li><li class="chapter-item expanded "><a href="../../../explore/resources/index.html"><strong aria-hidden="true">2.5.</strong> Resources</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../explore/resources/ide.html"><strong aria-hidden="true">2.5.1.</strong> IDE</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../specs/index.html"><strong aria-hidden="true">3.</strong> Specifications</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../specs/overview.html"><strong aria-hidden="true">3.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../../../specs/ledger.html"><strong aria-hidden="true">3.2.</strong> The ledger</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.3.</strong> Trade system</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.4.</strong> Intent gossip system</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.5.</strong> Fractal scaling</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.6.</strong> Upgrade system</div></li><li class="chapter-item expanded "><a href="../../../specs/encoding.html"><strong aria-hidden="true">3.7.</strong> Encoding</a></li></ol></li><li class="chapter-item expanded "><a href="../../../playnet/index.html"><strong aria-hidden="true">4.</strong> Playnet</a></li><li class="chapter-item expanded "><a href="../../../archive/index.html"><strong aria-hidden="true">5.</strong> Archive</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../archive/domain-name-addresses.html"><strong aria-hidden="true">5.1.</strong> Domain name addresses</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Anoma - Technical Specifications</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="accounts"><a class="header" href="#accounts">Accounts</a></h1>
<p><a href="https://github.com/anoma/anoma/issues/45">Tracking Issue</a></p>
<hr />
<p>There's only a single account type. Each account is associated with:</p>
<ul>
<li>a unique <a href="#addresses">address</a></li>
<li>a <a href="./vp.html">validity predicate</a></li>
<li><a href="#dynamic-storage-sub-space">dynamic storage sub-space</a></li>
</ul>
<h2 id="addresses"><a class="header" href="#addresses">Addresses</a></h2>
<p>There are two main types of address: transparent and shielded.</p>
<p>The transparent addresses are the addresses of accounts associated with dynamic storage sub-spaces, where the address of the account is the prefix key segment of its sub-space.</p>
<p>The shielded addresses are used for private transactions and they are not directly associated with storage sub-spaces.</p>
<h3 id="transparent-addresses"><a class="header" href="#transparent-addresses">Transparent addresses</a></h3>
<p>Furthermore, there are three types of transparent addresses:</p>
<ul>
<li>&quot;implicit&quot; addresses which are derived from public keys</li>
<li>&quot;established&quot; addresses which are generated from the current address nonce and hence must be created via a request in the ledger</li>
<li>&quot;internal&quot; addresses are used for special modules integrated into the ledger such as PoS and IBC.</li>
</ul>
<p>The addresses are stored on-chain encoded with <a href="https://github.com/bitcoin/bips/blob/master/bip-0350.mediawiki">bech32m</a> (<a href="https://github.com/zcash/zips/issues/484">not yet adopted in Zcash</a>), which is an improved version of <a href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki">bech32</a>.</p>
<p>The human-readable prefix (as specified for <a href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki#specification">bech32</a>) in the address encoding is:</p>
<ul>
<li><code>&quot;a&quot;</code> for Anoma live network</li>
<li><code>&quot;atest&quot;</code> for test network</li>
</ul>
<h4 id="implicit-transparent-addresses"><a class="header" href="#implicit-transparent-addresses">Implicit transparent addresses</a></h4>
<p>As implied by their name, accounts for implicit addresses exist as a possibility and not as a matter of fact. These addresses allow users to interact with public keys which may or may not have a registered on-chain account, e.g. allowing to send some fungible token to an address derived from a public key. An implicit address is derived from a hash of a public key, which also helps to protect keys for which the public key has not been revealed publicly.</p>
<h4 id="established-transparent-addresses"><a class="header" href="#established-transparent-addresses">Established transparent addresses</a></h4>
<p>Established addresses are created by a ledger transaction, which can create any number of new account addresses. The users are not in control of choosing the address as it's derived from the current address nonce, which is changed after every newly established address.</p>
<h4 id="internal-transparent-addresses"><a class="header" href="#internal-transparent-addresses">Internal transparent addresses</a></h4>
<p>There will be a static set of internal addresses that integrate certain functionality into the ledger via a dedicated module, such as the proof-of-stake module and the IBC module. The internal accounts use <a href="vp.html#native-vps">native validity predicates</a> to validate transactions that interact with their module. A native module will use the <a href="#dynamic-storage-sub-space">dynamic storage sub-space</a> to store all the data relevant to their functionality (e.g. PoS parameters, bond pool, IBC state and proofs).</p>
<h3 id="shielded-addresses"><a class="header" href="#shielded-addresses">Shielded addresses</a></h3>
<p>Similar to <a href="https://raw.githubusercontent.com/zcash/zips/master/protocol/protocol.pdf">Zcash Sapling protocol payment addresses and keys (section 3.1)</a>, users can generate spending keys for private payments. A shielded payment address, incoming viewing key and full viewing key are derived from a spending key. In a private payment, a shielded payment address is hashed with a diversifier into a diversified transmission key. When a different diversifier function is chosen for different transactions, it prevents the transmission key from being matched across the transactions.</p>
<p>The encoding of the shielded addresses, spending and viewing keys is not yet decided, but for consistency we'll probably use a the same schema with different prefixes for anything that can use an identifier.</p>
<ul>
<li>TODO consider using a schema similar to the <a href="https://github.com/zcash/zips/issues/482">unified addresses proposed in Zcash</a>, that are designed to unify the payment addresses across different versions by encoding a typecode and the length of the payment address together with it. This may be especially useful for the protocol upgrade system and fractal scaling system.</li>
</ul>
<h2 id="dynamic-storage-sub-space"><a class="header" href="#dynamic-storage-sub-space">Dynamic storage sub-space</a></h2>
<p>Each account can have an associated dynamic account state in the storage. This
state may be comprised of keys of the built-in supported types and values of arbitrary user bytes.</p>
<p>The dynamic storage sub-space could be a unix filesystem-like tree under the
account's address key-space with <code>read, write, delete, has_key, iter_prefix</code>
(and maybe a few other convenience functions for hash-maps, hash-sets, optional values, etc.) functions parameterized with the the account's address.</p>
<p>In addition, the storage sub-space would provide:</p>
<ul>
<li>a public type/trait for storage keys and key segments:
<ul>
<li>this should allow to turn types to storage key segments, key segments back to types</li>
<li>combine key segments into keys</li>
<li>can be extended with custom types in the code in a transaction</li>
</ul>
</li>
<li>a public type/trait for storage values:
<ul>
<li>values need to implement encoding traits, e.g. <code>BorshSerialize, BorshDeserialize</code>
<ul>
<li>this allows composition of types as specified for <a href="https://borsh.io">Borsh</a></li>
<li>the Merkle tree hashing function should hash values from the encoded bytes of this trait (the encoded value may be cached, because we update the Merkle tree in-memory before we commit the finalized block to the DB)</li>
</ul>
</li>
</ul>
</li>
<li>functions to get the size of a key and an encoded value (for storage fees)</li>
<li>the updates to account storage should be immediately visible to the transaction that performed the updates
<ul>
<li>validity predicate modifications have to be handled a little differently -
the old validity predicate should be run to check that the new validity
predicate (and other state changes included in the transaction) is valid</li>
</ul>
</li>
</ul>
<h2 id="initializing-a-new-account"><a class="header" href="#initializing-a-new-account">Initializing a new account</a></h2>
<p>A new account can be initialized on-chain with a transaction:</p>
<ul>
<li>anything be written into its storage (initial parameter)</li>
<li>a validity predicate has to be provided (we can have a default out-of-band)</li>
<li>at minimum, accounts need to be enumerated on chain, this could be done with an address or a counter</li>
</ul>
<p>A newly created account should be validated by all the VPs triggered by the transaction, i.e. it should be included in the set of changed keys passed to each VP. If the VPs are not interested in the newly created account, they can choose to ignore it.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../explore/design/ledger/epochs.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../../explore/design/ledger/vp.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../explore/design/ledger/epochs.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../../explore/design/ledger/vp.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../../../assets/mermaid.min.js"></script>
        <script type="text/javascript" src="../../../assets/mermaid-init.js"></script>
    </body>
</html>
